{{- define "main" -}}

<article class="container-fluid" id="skip-header-target">
    
    <div class="row">
        <div class="col-md-11 mx-auto mt-4">
            <nav aria-label="breadcrumb" class="mb-4">
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item"><a href="/key-topics/">Key Topics</a></li>
                    <li class="breadcrumb-item"><a href="..">
                        {{- with .Parent -}} {{ .Title }} </a></li>{{- end -}}
                        <li class="breadcrumb-item active" aria-current="page">{{ .Title }}</li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-11 mx-auto mb-4">
                    <h2>{{ .Title }}</h2>
                    <p>{{ .Content }}</p>



                    <div class="row mt-4">
                      <div class="col-6">

                        <div class="row mb-4">
                          <div class="col-12">
                            <h2 class="home-label border-bottom">Select a year</h2><br>
                          </div>
    
                          <div class="col-4">
                            <button type="button" class="btn btn-outline-secondary btn-block float-right" onclick="changeYear(-1)" id="downButton" disabled><i class="fas fa-arrow-circle-left h3 mx-2 pt-1"></i></button>
                          </div>
                          <div class="col">
                            <h3 id="year" class="text-center pt-1 font-weight-bold" style="font-size:2.5rem">2011</h3>
                          </div>
                          <div class="col-4">
                            <button type="button" class="btn btn-outline-secondary btn-block" onclick="changeYear(1)" id="upButton"><i class="fas fa-arrow-circle-right h3 mx-2 pt-1"></i></button>
                          </div>
                        </div>


                        <!--
                        <div class="row">
                          <div class="col-12">
                            <h2 class="home-label border-bottom">Click the slider to change years</h2>
                          </div>
                        </div>

                        <div class="row no-gutters">
                          <div class="col-1 ml-auto">
                            <i class="fas fa-arrow-circle-left float-right h3 mr-1 pt-1"></i>
                          </div>
                          <div class="col-8">
                            <input type="range" min="2011" max="2020" value="2011" class="slider pt-1" id="input">
                          </div>
                          <div class="col-1 mr-auto">
                            <i class="fas fa-arrow-circle-right h3 ml-1 pt-1"></i>
                          </div>
                        </div>
                         -->

                        <div class="row mt-4">
                          <div class="col-12 fs-lg">

                            <h2 class="home-label border-bottom">Summary data</h2>

                          Overall, <span id="citywide" class="font-weight-bold">XX %</span> of restaurants in NYC received A grades in <span id="year3" class="font-weight-bold">2011</span>.

                            <div class="row my-2">
                              <div class="col-4">
                                <span class="home-label border-bottom">Lowest:</span><br>
                                <span id="lowest">XX%</span>
                              </div>

                              <div class="col-4">
                                <span class="home-label border-bottom">Median:</span><br>
                                <span id="median">YY%</span>
                              </div>

                              <div class="col-4">
                                <span class="home-label border-bottom">Highest:</span><br>
                                <span id="highest">ZZ%</span>
                              </div>
                            </div>                            
                          
                            <h2 class="home-label border-bottom mt-4">What does it mean?</h2>
                            Over time, more restaurants have achieved A grades. This means that the grading system has helped restaurants become cleaner, safer, healthier places to eat. That's good news for all New Yorkers. 

                            <h2 class="home-label mt-4">Get inspection results for your favorite restaurant</h2>

                            <a href="https://a816-health.nyc.gov/ABCEatsRestaurants/#!/Search" class="button btn btn-lg btn-block btn-outline-primary mb-4" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link mr-1"></i>ABCEats: Restaurants</a>

                            <h2 class="home-label mt-4">See what health inspectors look for</h2>

                            <a href="../restaurant-inspection-checklist/" class="button btn btn-lg btn-block btn-outline-primary mb-4">Restaurant inspection checklist</a>
                            
                          </div>
                        </div>
                      </div>

                        <div class="col-6" style="height: 900px;">
                    
                        <h2 class="home-label border-bottom">Percent of restaurants with A grades (<span id="year2">2011</span>)</h2>

                        <div id="map"></div>

                        </div>


                    </div>

        </div>
        
    </div>

    <script>
        
        // set year default
        var year = '2011' 

        // changeYear runs on button click
        function changeYear(x) {
          year = Number(year);
          year = year + x

          if (year < 2011) {
            year = 2011
            document.getElementById('downButton').disabled = true
          } else if (year > 2020) {
            year = 2020
            document.getElementById('upButton').disabled = true
          } else {
            document.getElementById('downButton').disabled = false
            document.getElementById('upButton').disabled = false
          }
          console.log('year is:' + year)
          document.getElementById('year').innerHTML = year
          document.getElementById('year2').innerHTML = year
          document.getElementById('year3').innerHTML = year
          year = year.toString()
          spec.transform[0].filter = `datum.Time == ${year}` // update spec with chosen year
          vegaEmbed("#map", spec) // re-run map
          updateValues(year)
        }

        // ingest data for filtering and page printing
        var fullData = [];
        var partData = [];
        var uhfData = [];
        var cityValue = [];
        d3.csv('resto-data-full.csv').then(data => {
          fullData = data;
          console.log(fullData)
          updateValues(year)
        })

        // updateValues runs on button click, and updates page-printed values
        function updateValues(x) {
          console.log('to filter for:' + x)
          partData = fullData.filter(row => row.Time == year)
          console.log(partData)

          // get Citywide Value
          cityValue = partData.filter(row => row.GeoTypeDesc == 'Citywide')
          document.getElementById('citywide').innerHTML = cityValue[0].Percent + '%'

          // get lowest value
          const lowValue = partData.reduce(
            (acc, loc) =>
              acc.Percent < loc.Percent
              ? acc
              : loc
          )
          document.getElementById('lowest').innerHTML = lowValue.Percent + "%"

          // get highest value
          const highValue = partData.reduce(
            (acc, loc) => 
              acc.Percent > loc.Percent
              ? acc
              : loc
          )
          document.getElementById('highest').innerHTML = highValue.Percent + "%"

          // get median
          uhfData = partData.filter(row => row.GeoTypeDesc == 'UHF 42')
          console.log('uhf data:')
          console.log(uhfData)
          var valuesArray = [];
          for (let i = 0; i < uhfData.length; i++) {
            valuesArray.push(uhfData[i].Percent);
          }

          valuesArray.sort(function(a,b) {
            return a - b;
          })
          console.log(valuesArray)
          valuesArray.splice(0,20) // remove first 21 values
          document.getElementById('median').innerHTML = valuesArray[0] + '%'
        }


        // initial chart spec, updated and re-printed on year change
        var spec = {
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
          "width": "container",
          "data": {
            "url": "resto-data-full.csv",
            "format": {
              "type": "csv",
              "parse": {
                "Value": "number"
              }
            }
          },
          "transform": [
            {"filter": `datum.Time == ${year}`},
            {"filter": "datum.GeoTypeDesc === 'UHF 42'"}
          ],
          "params": [
            {"name": "highlight", "select": {"type": "point", "on": "mouseover"}}
          ],
          "projection": {"type": "mercator"},
          "vconcat": [
            {
              "height": 450,
              "width": "container",
              "mark": {"type": "geoshape", "stroke": "#000000"},
              "encoding": {
                "shape": {"field": "geo", "type": "geojson"},
                "color": {
                  "bin": false,
                  "field": "Percent",
                  "type": "quantitative",
                  "scale": {
                    "domain": [60, 100],  // Hardcoded domain values for 0%, 60%, and 100%
                    "range": ["#d8e7f3", "#230798"]  // Corresponding colors for 60% and 100%
                  },
                  "legend": {
                    "orient": "top",
                    "title": ""
                  }
                },
                "strokeWidth": {
                  "condition": [{"param": "highlight", "empty": false, "value": 2}],
                  "value": 0.5
                },
                "tooltip": [
                  {"field": "Geography", "type": "nominal", "title": "Neighborhood"},
                  {"field": "Percent", "type": "quantitative", "title": "Percent of restaurants with A grades"},
                  {"field": "Time", "type": "quantitative", "title": "Year"}
                ]
              },
              "transform": [
                {
                  "lookup": "GeoID",
                  "from": {
                    "data": {
                      "url": "https://raw.githubusercontent.com/nycehs/NYC_geography/master/UHF42.topo.json",
                      "format": {"type": "topojson", "feature": "collection"}
                    },
                    "key": "properties.GEOCODE"
                  },
                  "as": "geo"
                }
              ]
            },
                {
              "height": 150,
              "width": "container",
              "mark": {"type": "bar", "tooltip": true, "stroke": "#000000"},
              "encoding": {
                "y": {"field": "Percent", "type": "quantitative", "title": null,"scale": {"domain": [0, 100]}},
                "tooltip": [
                  {"field": "Geography", "type": "nominal", "title": "Neighborhood"},
                  {"field": "Percent", "type": "quantitative", "title": "Percent of restaurants with A grades"},
                  {"field": "Time", "type": "quantitative", "title": "Year"}
                ],
                "x": {"field": "GeoID", "sort": "y", "axis": null},
                "color": {
                  "bin": false,
                  "field": "Percent",
                  "type": "quantitative"
                },
                "strokeWidth": {
                  "condition": [{"param": "highlight", "empty": false, "value": 2}],
                  "value": 0.5
                }
              }
            }
          ]
        }

        // initial embedding of the map
        vegaEmbed("#map", spec)

        /*
        // Event listener for the slider
        var slider = document.getElementById('input')
        slider.addEventListener("input",function() {
            document.getElementById('yearOutput').innerHTML = slider.value
            year = slider.value
            spec.transform[0].filter = `datum.Time == ${year}` // update spec with chosen year
            vegaEmbed("#map", spec) // re-run map
        })
        */

    </script>

    <style>

        #map {
            width: 100%;
            max-height: 450px;
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 5px;
            background: #ffffff;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
          }
          
          .slider:hover {
            opacity: 1;
          }
          
          .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #04AA6D;
            cursor: pointer;
          }
          
          .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            background: #04AA6D;
            cursor: pointer;
          }
        </style>
    
</article>

{{- end -}}