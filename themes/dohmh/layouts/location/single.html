{{- define "main" -}}

<script>
    var topicIndicators;
    var sti;
    var thisInd;

    // this gets a json of topics and nested indicators
    async function getJSON() {
        d3.json({{ relURL "IndicatorData/topic_indicators.json" }}).then(data => {
            topicIndicators = data
        });
    }

    getJSON();

    // this is called when an indicator is clicked. it produces the indicator's data-explorer URL and sends it to the modal in report_indicator.html.

    const getURL = async (indID, dataname) => {

        console.log("getURL:", indID);

        var thisTopic = '';
        var topicArray = [];
        var ind = Number(indID)
        var URL;
        console.log('getURL running for ' + ind)

        for (let y in topicIndicators) {
            topicArray = topicIndicators[y].IndicatorID
            if (topicArray.includes(ind)) {
                thisTopic = y
                console.log('topic is: ' + ind + ": " + thisTopic)
                URL = {{ relURL "data-explorer/" }} + thisTopic + "/?id=" + ind; // creates URL
                document.getElementById(dataname).style.display = "block";
                document.getElementById(dataname).href = URL; // sends it to unique ID - Get the Dataset button
                return
            } else {
                // console.log('for ' + ind + ", no topic.")
                // document.getElementById(dataname).style.display = "none";
            }
        }
    }

    // ==== loading specs ==== //

    // ---- summary ---- //

    let summarySpec;

    d3.json("{{ site.Params.data_repo }}{{ site.Params.data_branch }}/neighborhood-reports/spec/summarySpec.json").then(data => {

        summarySpec = data;

        // highlight current neighborhood

        summarySpec.encoding.color.condition.test = "datum.neighborhood=='" + NeighborhoodName + "'";

    })

    // ---- map ---- //

    let mapSpec;

    d3.json("{{ site.Params.data_repo }}{{ site.Params.data_branch }}/neighborhood-reports/spec/mapSpec.json").then(data => {

        mapSpec = data;

        // highlight current neighborhood

        mapSpec.layer[2].encoding.stroke.condition.test = "datum.neighborhood == '" + NeighborhoodName + "'";

        // set data branch for geo files

        mapSpec.transform[0].from['data'].url = "{{ site.Params.data_repo }}{{ site.Params.data_branch }}/geography/UHF42.topo.json"
        mapSpec.layer[0].data.url = "{{ site.Params.data_repo }}{{ site.Params.data_branch }}/geography/borough.topo.json"

    });

    // ---- trend ---- //

    let trendSpec;

    d3.json("{{ site.Params.data_repo }}{{ site.Params.data_branch }}/neighborhood-reports/spec/trendSpec.json").then(data => {

        trendSpec = data;

        // highlight current neighborhood

        trendSpec.layer[1].encoding.color.condition.test = "datum.neighborhood=='" + NeighborhoodName + "'";

    });

</script>

{{/* Set scratch variables for neighborhood directory and report filename to be used in side bar */}}
{{- $.Scratch.Set "neighborhoodDir" .Parent.File.Dir -}}
{{- $.Scratch.Set "reportFile" .File.BaseFileName -}}

<div class="d-flex flex-column report-header d-print-none">

    <!-- Toggle #sidebar-nav on mobile -->
    <div class="container-fluid p-0 d-lg-none">
        <div>
            <div class="btn-toggle">
                <button class="btn btn-block btn-lg btn-primary shadow" data-toggle="collapse"
                        data-target="#sidebar-nav" aria-expanded="false" aria-controls="sidebar-nav">
                    <span class="title">Reports</span>
                </button>
            </div>
        </div>
    </div>

</div>

{{/* get report JSON from EHDP-data as a resource  */}}

{{- $reports_data := (resources.GetRemote (print site.Params.data_repo site.Params.data_branch "/neighborhood-reports/reports/" $.Params.data_json ".json")) | transform.Unmarshal -}}

{{/* First loop of report JSON to get first level parameters */}}

{{- range $reports_data -}}


<script>
    var NeighborhoodName = "{{ .geo_entity_name }}"; // setting for use in visualizations
    var report_name = "{{ $.Params.title }}"
    var data_download_loc = "{{ .data_download_loc }}"
</script>

<section class="container-fluid" id="skip-header-target">

    <div class="row mt-4">
        <div class="col-lg-10 mx-auto col-12">
            <nav aria-label="breadcrumb" class="mb-2">
                <ul class="breadcrumb">
                    <li class="breadcrumb-item"><a href={{ relURL "" }}>Home</a></li>
                    <li class="breadcrumb-item"><a href={{ relURL "neighborhood-reports" }}>Neighborhood Reports</a></li>
                    <li class="breadcrumb-item"><a href="" id="neighbLink">{{ $.Params.neighborhood }}</a></li>
                    <li class="breadcrumb-item active"><a href="{{ .RelPermalink }}">{{ $.Params.title }}</a></li>


                </ul>
            </nav>

            <h1 class="report-title border-bottom mt-4">{{ $.Params.title }} in 
                <span class="sub-title">{{ $.Params.neighborhood }}</span>
            </h1>

            <p class="report-description fs-lg mt-2 mb-4">{{ .report_description }}</p>


            <div class="row">
                <div class="col-md-9 h-100">
    
                <!-- REPORT CONTENT  -->
                <div class="row">
                    <div class="col-12">
                        <div>
    
                            {{- range $index, $content := .report_content -}}
                            {{- $count :=add $index 1 -}}
                            {{- $.Scratch.Set "location" .geo_entity_name -}}
                            {{- $.Scratch.Set "borough" .borough_name -}}
    
                            <div class="report-topic">
    
                                <div class="topic-header">
                                    <h2>{{ .report_topic }}</h2>
                                    <p>
                                        {{- .report_topic_description -}}
                                    </p>
                                </div>
    
                                <div class="container-fluid px-0 mb-4">
                                    <!-- Hide on print -->
                                    <div class="row indicator-headings mb-2 d-print-none">
                                        <div class="col-6 col-md-5 pl-3">
                                            Topic
                                        </div>
                                        <div class="col-6 col-md-4">
    
                                            <div class="position-relative">
                                                <span class="meta">Compared to other neighborhoods<a href="#" data-toggle="modal" data-target="#modal-rank"
                                                    class="info-modal meta"><i class="fas fa-question-circle fs-rg ml-1"></i> </span></a>
    
                                            </div>
    
                                        </div>
                                        <div class="d-none d-md-inline col-md-3">
                                            <span class="meta">All neighborhoods</span>
                                        </div>
                                    </div>
    
                                    <!-- Only show on print -->
                                    <div class="row indicator-headings mb-2 print-only">
                                        <div class="col-4 font-weight-bold">
                                            Topic
                                        </div>
                                        <div class="col-8">
    
                                            <div class="position-relative">
                                                <span class="meta">Compared to other neighborhoods</span>
                                            </div>
    
                                        </div>
                                    </div>
    
                                    {{- with .report_topic_data -}}
                                    {{- range sort . "data_value_rank" "desc" -}}
                                    {{- $location := $.Scratch.Get "location" -}}
                                    {{- $borough := $.Scratch.Get "borough" -}}
                                    {{- partial "report_indicator.html" (dict "location" $location "borough" $borough "ind" . "count" $count) -}}
                                    {{- end -}}
                                    {{- end -}}
                                </div>
                                <!-- .container -->
    
                            </div>
                            <!-- .report-topic -->
                            {{- end -}}
    
                        </div>
    
    
                    </div>
                </div>

                </div>
    
                <!-- NAV RIGHT SIDEBAR -->
                <div class="col-md-3 h-100">
                    <div class="border mb-2" style="height: 100%">
                        <div class="p-1">
                            <p><strong style="color:#00923E">{{ .geo_entity_name }}</strong> includes ZIP Codes: <span
                                class="home-label font-weight-bold" id="zips"> insert ZIP codes </span>.</p>
                        </div>

                        {{- partial "nr-map-highlight" . -}}
                    </div>

                    <nav role="navigation">
                        <div class="">
                            {{- $neighborhood := $.Scratch.Get "neighborhoodDir" -}}
                            {{- $report := $.Scratch.Get "reportFile" -}}
                            {{- partial "location_sub_nav" (dict  "neighborhood" $neighborhood "report" $report) -}}
                        </div>
                    </nav>

                    <hr class="my-2">
                    <button onclick="window.print()" class="btn btn-sm btn-block btn-report mt-2" target="_blank"><i class="fas fa-print mr-1"></i>Print Report</button>

                    <button onclick="downloadData()" class="btn btn-sm btn-block btn-report mt-2" target="_blank"><i class="fa fa-download mr-1"></i>Download Report Data <span class="sr-only">(opens in a new tab)</span></button>



                </div>
            </div>

        </div>



    </div>

    <script>

        // loading report CSV data here, so it only loads once per location

        var arqTable;
        var downloadLoc = "{{ site.Params.data_repo }}{{ site.Params.data_branch }}/neighborhood-reports/data/" + data_download_loc

        // loading report-level CSV data

        aq.loadCSV(
            downloadLoc,
            { autoMax: 10000,  parse: { time: String } }
        )
        .then(data => { arqTable = data })

        {{/*  console.log("arqTable", arqTable);  */}}


        // set data download location
        var reportData;
        var download;

        // create an element, create the CSV, and download it
        function downloadData() {

            download = arqTable
                .select(aq.not('report_id','indicator_id','data_field_name','start_date','end_date')) // drop unnecessary columns
                .filter(d => d.neighborhood == '{{ .geo_entity_name }}')

            let downloadTableCSV = download.toCSV(); // format as CSV
            // Data URI
            let csvData = 'data:application/csv;charset=utf-8,' + encodeURIComponent(downloadTableCSV);
            let hiddenElement = document.createElement('a');
            hiddenElement.href = csvData;
            hiddenElement.target = '_blank';
            hiddenElement.download = 'NYC EH Data Portal - Neighborhood Report - ' + report_name + " - {{ .geo_entity_name }}.csv";
            hiddenElement.click();

            gtag('event', 'file_download', {
                'file_name': hiddenElement.download,
                'file_extension': '.csv',
                'link_text': 'Download Report Data'
            });

        };

    </script>

</section>
{{/* Make sure we know what report content to load and that content_yml is set. If not we dont display the content */}}
{{- if $.Params.content_yml -}}

{{/* Variable to load the the data file from the content_yml frontmatter */}}
{{- $content := index $.Site.Data.globals.report_content $.Params.content_yml -}}
<section class="related-reading d-print-none">
    <div class="container">
        <div class="row">

            <div class="col-lg">
                <div class="card bg-white text-black mb-2">
                    <div class="card-header">What is the City doing?</div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {{- range $content.city -}}
                            <li class="list-group-item border-0 py-1 bg-transparent">{{ if .link }}<a
                                   href="{{ .link }}">{{- end -}}{{ .copy }}{{ if .link }}</a>{{- end -}}</li>
                            {{- end -}}
                        </ul>
                    </div>
                </div>
            </div>
            <!-- .col for city -->

            <div class="col-lg">
                <div class="card bg-white text-black mb-2">
                    <div class="card-header">What can you do?</div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {{- range $content.you -}}
                            <li class="list-group-item border-0 py-1 bg-transparent">{{ if .link }}<a
                                   href="{{ .link }}">{{- end -}}{{ .copy }}{{ if .link }}</a>{{- end -}}</li>
                            {{- end -}}
                        </ul>
                    </div>
                </div>
            </div>
            <!-- .col for you -->

            <div class="col-lg">
                <div class="card bg-white text-black">
                    <div class="card-header">More NYC neighborhood data</div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {{- range $content.data -}}
                            <li class="list-group-item border-0 py-1 bg-transparent">{{ if .link }}<a
                                   href="{{ .link }}">{{- end -}}{{ .copy }}{{ if .link }}</a>{{- end -}}</li>
                            {{- end -}}
                        </ul>
                    </div>
                </div>
            </div>
            <!-- .col for data -->

            <!-- .row -->
        </div>
    </div>
</section>
{{- end -}}

<!--
    <section class="py-6">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 offset-lg-4 overflow-hidden">
                    <div class="narrow">
                        <h2>More Information</h2>
                        <p>{{ .report_footer }}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
-->

<!-- Modal-Rank -->
<div class="modal fade report-modal" id="modal-rank" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="exampleModalLabel">Indicator ranking</h4>
                <button type="button" class="close no-btn-style" data-dismiss="modal" aria-label="Close">
                    <span class="fas fa-times-circle"></span>
                </button>
            </div>
            <div class="modal-body">
                <p>Each indicator is placed in one of three categories:</p>
                <ul>
                    <li class="mb-2"><span class="better">Better</span></li>
                    <li class="mb-2"><span class="middle">Middle</span></li>
                    <li><span class="worse">Worse</span></li>
                </ul>
                <p>This shows us how the neighborhood compares to other NYC neighborhoods, if you ranked all of the NYC
                    neighborhoods based on this indicator.</p>
                <ul>
                    <li><strong>Better:</strong> in the top 1/3rd of all NYC neighorhoods.</li>
                    <li><strong>Middle:</strong> it's close to the NYC median - ranking somewhere in the middle third of
                        all neighborhoods.</li>
                    <li><strong>Worse:</strong> in the bottom 1/3rd of NYC neighborhoods.</li>
                </ul>
                <p>These are only based on the distribution of data values, not the range. The absolute values of
                    indicators in different categories may not be all that different.</p>

            </div>
            <!-- .modal-body -->
            <div class="modal-footer">
                <button type="button" class="btn btn-primary px-6" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{{- end -}}

{{- $js := resources.Get "js/uhflist.js" -}}
{{ $secureJS := $js | resources.Fingerprint "sha512" }}
<script type="text/javascript" src="{{ $secureJS.RelPermalink }}" integrity="{{ $secureJS.Data.Integrity }}"></script>

<script type="text/javascript">
    // get report path relative to section starting with "neighborhood-reports"
    var thisURL = window.location.pathname.match(/neighborhood-reports.*/)
    var thisNeighb = thisURL[0].split("/")[1]; // get this neighborhood
    var report = thisURL[0].split("/")[2]; // get this report
    reportURL = '/' + report // get URL extension

</script>

{{- end -}}